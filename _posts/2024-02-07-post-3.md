---
title: One Player Optimal
date: 2023-11-31
categories: [Code]
tags: [blog]
math: true
---
![Kiku](../../images/t1.gif)

# Introduction
Suppose you would like to get from a certain location to another, but you would like to minimize the inputs you need from your car. How would you find that trajectory?
# Problem Introduction
We begin by initiating a state vector $S$ where at each time-frame $t \in [1,T]$ holds $(x,y,\theta,\upsilon)$, where $x$ represents the x-coordinate of the car, $y$ represents the y-coordinate of the car, $\theta$ represents the car's heading, and $\upsilon$ represents the car's velocity. We want to make sure that at the end, $S_T = S_f$, where $S_f$ is our target pose. In addition, each time-frame will hold a vector of control inputs $u$, where $u_{(1,t)}$ represents change in heading and $u_{(2,t)}$ represents change in velocity.

The formulation of our problem solely off our state vector would return numerous control inputs that yield a viable solution, hence we must minimize the control input as an additional constraint. We define our objective function as
$$f(z)=\vert \vert u \vert \vert^2$$
where $f:\mathbb{R}^n \rightarrow \mathbb{R}$, $z = [x;u]$, and $n = 4T + 2T$.

In order to verify the state of the trajectory at each timestamp matches what the state vector at the previous timestamp predicts, we must also implement a Dynamic-Feasibility constraint $h$. Based off the first $4T$ indexes of $z$, it constrains that
$$h(z)= \begin{bmatrix} S_1 - (S_0 + S_0' \Delta t)\\ S_2 - (S_1 + S_1' \Delta t) \\ \vdots \\ S_T - (S_{T-1} + S_{T-1}' \Delta t) \\ S_T - S_f \\ \end{bmatrix} = 0$$
where $h:\mathbb{R}^n \rightarrow \mathbb{R}^m$, and $m = 4T + 4$.

Specifically at each time-stamp $t$, it requires, 
$$x_t - \big( x_{t-1} + dt \cdot \cos({\theta_{t-1}}) * v_{t-1} \big) = 0$$
$$y_t - \big( y_{t-1} + dt \cdot \sin({\theta_{t-1}}) * v_{t-1} \big) = 0$$
$$\theta_t - \big( \theta_{t-1} + dt \cdot u_{(1,t-1)}) = 0$$
$$\upsilon_t - \big( \upsilon_{t-1} + dt \cdot u_{(2,t-1)}) = 0$$

# Problem Statement
Our optimization problem is to 
$$\min f(z)$$
$$\textnormal{subject to } h(z) = 0$$
## Example
![Kiku](../../images/t2.gif)


# Solution
Solving this optimization problem requires to find a trajectory that satisfies the KKT conditions of optimality. Since our optimization problem only consists of equality constraints, our KKT conditions would consist of only the gradient of the Lagrangian and dynamic feasibility.

As a vector, our KKT conditions
$$F(z,h) = \begin{bmatrix} \nabla \mathscr{L} \\ h(z) \end{bmatrix} = \begin{bmatrix} \nabla f(z) - A(z)^\intercal \lambda  \\ h(z) \end{bmatrix} = 0$$
where $\mathscr{L} = f(z) + \lambda^\intercal h(z)$, $\lambda \in \mathbb{R}^m$.

$A(z)$, the Jacobian of our Dynamic Feasibility, is defined as
$$A(z) = [\nabla h_1(z), \nabla h_2(z) \dots \nabla h_m(z)]$$
with dimensions $6T$ by $4T+4$.

The above statement is a system of equations where we look to find the $\lambda$ values that satisfy the KKT constraints. We can refer to Julia's Ipopt to solve this system of equations, where once $\lambda$ is found, the correlating state vector is our optimal trajectory.

## Additional Math
It is important to note that in Ipopt, we can't call the Jacobian of a function, hence, we must manually take the derivative.

<blockquote style="color: #1e2f97; border-left-color: #1e2f97">
<b>Gradient of Objective Function</b>
</blockquote>
![Kiku](../../images/objectivefunctionderivative.png)

<blockquote style="color: #1e2f97; border-left-color: #1e2f97">
<b>Jacobian of Primal Feasibility</b>
</blockquote>
For the Jacobian of $h(z)$, or $A(z)$, at each timestamp $t$, we can construct the following matrix of dimension $4$ by $8$, with the top-left index at index $(4t-4,4t-4)$ in $A(z)$.
$$\begin{blockarray}{ccccccccc} & & & & & & & & \textnormal{State Vector}\\ \begin{block}{(cccccccc)c}  1 & 0 & 0 & 0 & -1 & 0 & 0 & 0 & x_t\\ 0 & 1 & 0 & 0 & 0 & -1 & 0 & 0 & y_t\\  0 & 0 & 1 & 0 & \Delta t \sin(\theta_t)\upsilon_t & - \Delta t \cos(\theta_t)\upsilon_t& -1 & 0 & \theta_t\\   0 & 0 & 0 & 1 & -\Delta t \cos(\theta_t)\upsilon_t & - \Delta t \sin(\theta_t)\upsilon_t& 0 & -1 & \upsilon_t \end{block} \end{blockarray} $$
For the last $2T$ rows of $A(z)$, at each timestamp $t$, $u_{(1,t)}$ would have a derivative of $-dt$ at only column $4t+3$ and $0$ otherwise, and $u_{(2,t)}$ would have a derivative of $-dt$ at only column $4t+4$ and $0$ otherwise.


# Code
See below:
## [Code](https://github.com/Rich-Nyan/optimal/blob/main/OnePlayer.jl)
